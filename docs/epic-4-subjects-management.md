# Epic 4: Gesti√≥n de Materias y Asignaciones

**üèÜ Prioridad: MEDIA** | **Complejidad: Baja** | **Sprint: 2**

---

## üìù **Descripci√≥n de la √âpica**

Como administrador, necesito gestionar el cat√°logo de materias y las asignaciones de profesores a materias espec√≠ficas, para controlar qu√© profesores pueden impartir asesor√≠as de cu√°les materias y mantener la integridad del sistema.

**Valor de Negocio**: Control administrativo completo sobre la oferta acad√©mica y asignaciones docentes.

---

## üéØ **Historias de Usuario**

### **US-013: Admin gestiona cat√°logo de materias**

```gherkin
Como administrador
Quiero gestionar el cat√°logo completo de materias de la universidad
Para mantener actualizada la oferta acad√©mica disponible

Given soy un administrador autenticado
When navego a "Administraci√≥n" ‚Üí "Materias"
Then veo tabla paginada con todas las materias:
  - C√≥digo de materia
  - Nombre completo
  - Cr√©ditos
  - Estado: Activa/Inactiva
  - # Profesores asignados
  - Acciones: [Editar] [Ver Profesores] [Activar/Desactivar]

When hago clic en "Nueva Materia"
Then aparece modal con:
  - C√≥digo: [input] ej: "CALC001"
  - Nombre: [input] ej: "C√°lculo Diferencial"
  - Descripci√≥n: [textarea, opcional]
  - Cr√©ditos: [number]
  - Activa: [checkbox, default: true]

When completo y guardo
Then materia se crea y aparece en la tabla
And est√° disponible para asignar profesores
And aparece en dropdowns de creaci√≥n de asesor√≠as (si hay profesores asignados)
```

**Criterios de Aceptaci√≥n**:
- ‚úÖ C√≥digo de materia debe ser √∫nico
- ‚úÖ Nombre de materia debe ser √∫nico
- ‚úÖ Solo materias activas aparecen en formularios de usuarios
- ‚úÖ No puedo eliminar materias con asesor√≠as registradas
- ‚úÖ Puedo desactivar materias para ocultar sin eliminar
- ‚úÖ B√∫squeda por c√≥digo o nombre en la tabla

**Endpoints**:
```http
GET /api/admin/subjects
Query params: ?page=1&search=calc&status=active
Response: {
  "subjects": [{
    "id": 1,
    "code": "CALC001", 
    "name": "C√°lculo Diferencial",
    "credits": 6,
    "isActive": true,
    "assignedProfessors": 3,
    "totalSessions": 25
  }],
  "pagination": {"page": 1, "totalPages": 10}
}

POST /api/admin/subjects
Body: {
  "code": "CALC001",
  "name": "C√°lculo Diferencial", 
  "description": "Materia fundamental de matem√°ticas",
  "credits": 6,
  "isActive": true
}

PUT /api/admin/subjects/:id
PATCH /api/admin/subjects/:id/toggle-status
```

---

### **US-014: Admin gestiona asignaciones profesor-materia**

```gherkin
Como administrador
Quiero asignar profesores a materias espec√≠ficas
Para controlar qui√©n puede impartir asesor√≠as de cada materia

Given tengo materias creadas y profesores registrados
When navego a "Administraci√≥n" ‚Üí "Asignaciones"
Then veo dos vistas disponibles:
  - Vista por Profesor: lista profesores con sus materias asignadas
  - Vista por Materia: lista materias con profesores asignados

En Vista por Profesor:
When hago clic en un profesor
Then veo sus materias actuales y bot√≥n "Asignar Nueva Materia"
When selecciono "Asignar Nueva Materia"
Then aparece modal con:
  - Materia: [dropdown de materias activas no asignadas al profesor]
  - Fecha inicio: [date picker, default: hoy]
  - Fecha fin: [date picker, opcional]
  - Activa: [checkbox, default: true]

En Vista por Materia:
When hago clic en una materia
Then veo profesores asignados y bot√≥n "Asignar Profesor"
When selecciono "Asignar Profesor" 
Then aparece modal similar para asignar nuevo profesor

When confirmo asignaci√≥n
Then se crea registro en SubjectDetails/TeachingAssignment
And profesor puede crear asesor√≠as para esa materia
And estudiantes de esa materia pueden solicitar asesor√≠as con ese profesor
```

**Criterios de Aceptaci√≥n**:
- ‚úÖ Un profesor puede ense√±ar m√∫ltiples materias
- ‚úÖ Una materia puede ser impartida por m√∫ltiples profesores
- ‚úÖ No puedo crear asignaci√≥n duplicada (profesor-materia ya existente)
- ‚úÖ Puedo desactivar asignaciones sin eliminar historial
- ‚úÖ Fecha de fin permite asignaciones temporales
- ‚úÖ Solo asignaciones activas permiten crear asesor√≠as

**Endpoints**:
```http
GET /api/admin/assignments/by-professor
Response: [{
  "professor": {"id": 1, "name": "Dr. Garc√≠a"},
  "assignments": [{
    "id": 10,
    "subject": {"code": "CALC001", "name": "C√°lculo"},
    "startDate": "2025-01-15",
    "endDate": null,
    "isActive": true,
    "sessionsCount": 12
  }]
}]

GET /api/admin/assignments/by-subject  
Response: [{
  "subject": {"id": 1, "code": "CALC001", "name": "C√°lculo"},
  "assignments": [{
    "professor": {"name": "Dr. Garc√≠a"},
    "startDate": "2025-01-15",
    "isActive": true
  }]
}]

POST /api/admin/assignments
Body: {
  "professorId": 5,
  "subjectId": 2,
  "startDate": "2025-01-15",
  "endDate": "2025-12-15", // opcional
  "isActive": true
}

PATCH /api/admin/assignments/:id/toggle-status
DELETE /api/admin/assignments/:id // solo si no hay sesiones creadas
```

---

### **US-015: Validaci√≥n de integridad acad√©mica**

```gherkin
Como sistema
Quiero validar que las asignaciones y permisos sean coherentes acad√©micamente
Para mantener integridad de datos y evitar inconsistencias

Given un profesor intenta crear asesor√≠a
When selecciona una materia
Then el sistema valida que tenga asignaci√≥n activa para esa materia
And si no la tiene, muestra error: "No tienes permisos para impartir esta materia"

Given un estudiante intenta solicitar asesor√≠a
When selecciona materia y profesor
Then el sistema valida que:
  - El estudiante est√© matriculado en esa materia
  - El profesor tenga asignaci√≥n activa para esa materia
  - La asignaci√≥n est√© vigente (dentro de fechas si est√°n definidas)
And si alguna validaci√≥n falla, muestra error espec√≠fico

Given un admin intenta desactivar una asignaci√≥n
When la asignaci√≥n tiene sesiones futuras programadas
Then el sistema muestra advertencia: "Esta asignaci√≥n tiene X sesiones programadas. ¬øContinuar?"
And permite elegir qu√© hacer con las sesiones existentes:
  - Cancelar sesiones futuras
  - Transferir a otro profesor de la misma materia
  - Mantener sesiones pero no permitir nuevas
```

**Criterios de Aceptaci√≥n**:
- ‚úÖ Validaciones en tiempo real antes de permitir acciones
- ‚úÖ Mensajes de error claros y espec√≠ficos
- ‚úÖ Advertencias para acciones que afectan datos existentes
- ‚úÖ Opciones para manejar dependencias cuando se modifican asignaciones
- ‚úÖ Log de auditor√≠a de cambios de asignaciones

**Endpoints**:
```http
POST /api/admin/assignments/validate
Body: {
  "action": "CREATE_SESSION|REQUEST_ADVISORY",
  "professorId": 5,
  "subjectId": 2,
  "studentId": 100 // solo para REQUEST_ADVISORY
}
Response: {
  "isValid": true|false,
  "errors": ["Professor not assigned to this subject"],
  "warnings": ["Assignment expires in 30 days"]
}

GET /api/admin/assignments/:id/impact-analysis
Response: {
  "futureSessions": 5,
  "pendingRequests": 2,
  "affectedStudents": 15,
  "recommendedActions": ["Transfer to Dr. Smith", "Cancel sessions"]
}
```

---

### **US-016: Profesor visualiza sus asignaciones**

```gherkin
Como profesor
Quiero ver todas mis asignaciones de materias actuales y pasadas
Para conocer para qu√© materias puedo crear asesor√≠as

Given soy un profesor autenticado
When navego a "Mis Materias" 
Then veo dos secciones:

Materias Activas:
  - Lista de materias que actualmente puedo impartir
  - Para cada materia: nombre, c√≥digo, fecha de asignaci√≥n
  - Estad√≠sticas: # asesor√≠as impartidas, # estudiantes atendidos
  - Bot√≥n "Crear Asesor√≠a" para cada materia

Historial de Asignaciones:
  - Materias que impart√≠ en el pasado (desactivadas o con fecha fin)
  - Solo lectura, con estad√≠sticas hist√≥ricas
  - Posibilidad de ver reportes hist√≥ricos

When hago clic en "Crear Asesor√≠a" de una materia activa
Then me redirige al formulario de creaci√≥n con la materia preseleccionada
And solo veo estudiantes matriculados en esa materia espec√≠fica
```

**Criterios de Aceptaci√≥n**:
- ‚úÖ Solo veo mis propias asignaciones
- ‚úÖ Distinci√≥n clara entre asignaciones activas e hist√≥ricas
- ‚úÖ Estad√≠sticas precisas por materia
- ‚úÖ Acceso r√°pido a crear asesor√≠as desde mis materias activas
- ‚úÖ Filtrado autom√°tico de estudiantes por materia seleccionada

**Endpoints**:
```http
GET /api/professors/my-assignments
Response: {
  "active": [{
    "id": 10,
    "subject": {"code": "CALC001", "name": "C√°lculo Diferencial"},
    "startDate": "2025-01-15",
    "stats": {
      "totalSessions": 25,
      "studentsHelped": 45,
      "avgAttendance": 85
    }
  }],
  "historical": [{
    "subject": {"name": "√Ålgebra Lineal"},
    "period": "2024-01-15 to 2024-12-15",
    "finalStats": {...}
  }]
}
```

---

## üîß **Cambios T√©cnicos Requeridos**

### **Modificaciones a Subject entity**:
```typescript
// Agregar campos de gesti√≥n
@Column({ unique: true })
code: string; // c√≥digo de materia ej: "CALC001"

@Column('text', { nullable: true })
description: string;

@Column()
credits: number;

@Column({ default: true })
isActive: boolean;

@CreateDateColumn()
createdAt: Date;

@UpdateDateColumn()
updatedAt: Date;

// Relaci√≥n inversa para obtener estad√≠sticas
@OneToMany(() => SubjectDetails, sd => sd.subject)
assignments: SubjectDetails[];
```

### **Modificaciones a SubjectDetails entity**:
```typescript
// Renombrar a TeachingAssignment para mayor claridad
@Entity('teaching_assignments')
export class TeachingAssignment {
  // Campos de control temporal
  @Column({ type: 'date', nullable: true })
  startDate: string;

  @Column({ type: 'date', nullable: true })
  endDate: string;

  @Column({ default: true })
  isActive: boolean;

  @CreateDateColumn()
  assignedAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;

  // Auditor√≠a
  @ManyToOne(() => User)
  assignedBy: User; // admin que hizo la asignaci√≥n
}
```

### **Nuevo: AssignmentAuditLog**:
```typescript
@Entity()
export class AssignmentAuditLog {
  @PrimaryGeneratedColumn()
  id: number;

  @ManyToOne(() => TeachingAssignment)
  assignment: TeachingAssignment;

  @Column({ 
    type: 'enum',
    enum: ['CREATED', 'ACTIVATED', 'DEACTIVATED', 'DELETED'] 
  })
  action: string;

  @ManyToOne(() => User)
  performedBy: User;

  @Column('json', { nullable: true })
  previousValues: any;

  @Column('json', { nullable: true })
  newValues: any;

  @Column({ nullable: true })
  reason: string;

  @CreateDateColumn()
  performedAt: Date;
}
```

---

## üìä **Vista de Administraci√≥n (UI Mockup)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Gesti√≥n de Materias y Asignaciones ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                   ‚îÇ
‚îÇ  üìã Materias  üë• Asignaciones  üìä Reportes                        ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  üîç [Buscar materias...]                    [Nueva Materia]      ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ C√≥digo    ‚îÇ Materia              ‚îÇ Profesores ‚îÇ Estado    ‚îÇ   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ  ‚îÇ CALC001   ‚îÇ C√°lculo Diferencial  ‚îÇ    3       ‚îÇ ‚úÖ Activa ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ALG001    ‚îÇ √Ålgebra Lineal       ‚îÇ    2       ‚îÇ ‚úÖ Activa ‚îÇ   ‚îÇ  
‚îÇ  ‚îÇ FISI001   ‚îÇ F√≠sica I             ‚îÇ    1       ‚îÇ ‚ùå Inact. ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                   ‚îÇ  
‚îÇ  üìã Vista por: ‚óâ Profesor  ‚óã Materia                             ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  üë®‚Äçüè´ Dr. Garc√≠a                                 [Asignar Materia] ‚îÇ
‚îÇ     ‚Ä¢ CALC001 - C√°lculo Diferencial (25 sesiones)                ‚îÇ
‚îÇ     ‚Ä¢ ALG001 - √Ålgebra Lineal (12 sesiones)                      ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß™ **Casos de Prueba Cr√≠ticos**

1. **Creaci√≥n de materia**: Admin crea nueva materia ‚Üí Aparece en dropdowns despu√©s de asignar profesor
2. **Asignaci√≥n**: Admin asigna profesor a materia ‚Üí Profesor puede crear asesor√≠as de esa materia
3. **Validaci√≥n de permisos**: Profesor intenta crear asesor√≠a de materia no asignada ‚Üí Error 403
4. **Desactivaci√≥n con dependencias**: Admin desactiva asignaci√≥n con sesiones futuras ‚Üí Opciones para manejar conflictos
5. **Estudiante sin matr√≠cula**: Estudiante solicita asesor√≠a de materia no matriculada ‚Üí Error de validaci√≥n
6. **Fechas de asignaci√≥n**: Profesor con asignaci√≥n vencida intenta crear asesor√≠a ‚Üí Error de validaci√≥n temporal

---

*√öltima actualizaci√≥n: 31 de octubre de 2025*